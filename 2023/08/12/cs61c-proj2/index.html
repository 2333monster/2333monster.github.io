

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Titor">
  <meta name="keywords" content="">
  
    <meta name="description" content="cs61c - Great Ideas in Computer Architecture (Machine Structures) proj2 笔记">
<meta property="og:type" content="article">
<meta property="og:title" content="cs61c-proj2">
<meta property="og:url" content="https://2333monster.github.io/2023/08/12/cs61c-proj2/index.html">
<meta property="og:site_name" content="moxilai">
<meta property="og:description" content="cs61c - Great Ideas in Computer Architecture (Machine Structures) proj2 笔记">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://2333monster.github.io/2023/08/12/cs61c-proj2/Task7_read_matrix_arguments.png">
<meta property="article:published_time" content="2023-08-12T12:58:06.000Z">
<meta property="article:modified_time" content="2023-09-15T14:52:40.620Z">
<meta property="article:author" content="John Titor">
<meta property="article:tag" content="cs61c">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://2333monster.github.io/2023/08/12/cs61c-proj2/Task7_read_matrix_arguments.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>cs61c-proj2 - moxilai</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"2333monster.github.io","root":"/","version":"1.9.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>moxilai</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="cs61c-proj2"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-08-12 20:58" pubdate>
          2023年8月12日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          12k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          96 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">cs61c-proj2</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="Project-2-CS61Classify"><a href="#Project-2-CS61Classify" class="headerlink" title="Project 2: CS61Classify"></a>Project 2: CS61Classify</h1><blockquote>
<p>cs61c - Great Ideas in Computer Architecture (Machine Structures) proj2 笔记</p>
<p>课程主页：<a target="_blank" rel="noopener" href="https://inst.eecs.berkeley.edu/~cs61c/fa20/#by-week">https://inst.eecs.berkeley.edu/~cs61c/fa20/#by-week</a></p>
<p>个人仓库：<a target="_blank" rel="noopener" href="https://github.com/2333monster/my-cs61c-proj">https://github.com/2333monster/my-cs61c-proj</a></p>
<p>注：是sp22 的proj2</p>
</blockquote>
<h2 id="Part-A-Math-Functions"><a href="#Part-A-Math-Functions" class="headerlink" title="Part A: Math Functions"></a>Part A: Math Functions</h2><p> 完成</p>
<ul>
<li>abs</li>
<li>dot product</li>
<li>matrix multiplication</li>
<li>an element-wise rectifier function (ReLU)</li>
<li>an argmax function for vectors.</li>
</ul>
<h3 id="Task-1-Absolute-Value-Walkthrough"><a href="#Task-1-Absolute-Value-Walkthrough" class="headerlink" title="Task 1: Absolute Value (Walkthrough)"></a>Task 1: Absolute Value (Walkthrough)</h3><p>熟悉工作流</p>
<h4 id="Running-Tests"><a href="#Running-Tests" class="headerlink" title="Running Tests"></a>Running Tests</h4><p>在linux 环境下，进行操作即可</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">bash test.sh<br>bash test.sh part_a <br>bash test.sh test_abs<br></code></pre></td></tr></table></figure>

<h4 id="Using-VDB-to-debug-tests-via-Venus"><a href="#Using-VDB-to-debug-tests-via-Venus" class="headerlink" title="Using VDB to debug tests via Venus"></a>Using VDB to debug tests via Venus</h4><p>根据<a target="_blank" rel="noopener" href="https://inst.eecs.berkeley.edu/~cs61c/sp22/projects/proj2/#setup-venus">the setup section of the spec</a> 设置venus，注意在linux 下即可</p>
<p>在&#x2F;src&#x2F;abs.s 中添加ebreak</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs assembly">abs:<br>	# Prologue<br>    ebreak<br>	# PASTE HERE<br><br>    blt a0, zero, done<br><br>    # Negate a0<br>    sub a0, x0, a0<br><br>	done:<br>	  ret<br>	# Epilogue<br></code></pre></td></tr></table></figure>

<p>在terminal 中，运行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd /vmfs/test-src<br>vdb test_abs_one.s <br></code></pre></td></tr></table></figure>

<p>然后再simulator 中debug就好，发现错误后（大于0但是取了相反数），修改</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs assembly">abs:<br>	# Prologue<br>    ebreak<br>	# PASTE HERE<br><br>    bge a0, zero, done<br><br>    # Negate a0<br>    sub a0, x0, a0<br><br>	done:<br>	  ret<br>	# Epilogue<br></code></pre></td></tr></table></figure>

<h3 id="Task-2-ReLU"><a href="#Task-2-ReLU" class="headerlink" title="Task 2: ReLU"></a>Task 2: ReLU</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs assembly">relu:<br>    # ebreak<br>	# Prologue<br>    li t5,1<br>    blt a1,t5,exit_relu<br>    add t0, x0,x0<br>    addi t2, x0, 4<br>loop_start:<br>	beq t0, a1, loop_end<br>	mul t1, t0, t2<br>    add t3, a0, t1<br>    lw t4, 0(t3)<br>	bgt t4, x0, loop_continue<br>	sw zero, 0(t3)<br>loop_continue:<br>	addi t0, t0, 1<br>	j loop_start<br>loop_end:<br>	# Epilogue<br>	ret<br>exit_relu:<br>    li a0 36<br>    j exit<br></code></pre></td></tr></table></figure>

<h3 id="Task-3-Argmax"><a href="#Task-3-Argmax" class="headerlink" title="Task 3: Argmax"></a>Task 3: Argmax</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs assembly">argmax:<br>    ebreak<br>    # Prologue<br>    li t5, 1<br>    blt a1, t5, exit_argmax<br>    li t0,0         #max_index<br>    lw t1,0(a0)     #max_value<br>    add t2,x0,x0    #i<br>    li t5,4<br>loop_start:<br>    beq t2,a1,loop_end<br>    mul t4,t2,t5    #4i<br>    add t6,a0,t4    #&amp;a0[i]<br>    lw t3,0(t6)     #a0[i]<br>    bge t1,t3,loop_continue<br>    mv t1,t3<br>    mv t0,t2<br>loop_continue:<br>    addi t2,t2,1<br>    j loop_start<br>exit_argmax:<br>    li a0,36<br>    j exit<br>loop_end:<br>    mv a0,t0<br>    ret<br></code></pre></td></tr></table></figure>

<h3 id="Task-4-Dot-Product"><a href="#Task-4-Dot-Product" class="headerlink" title="Task 4: Dot Product"></a>Task 4: Dot Product</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs assembly">dot:<br>	ebreak<br>	# Prologue<br>	li t5,1<br>	blt a2,t5,exit_36<br>	blt a3,t5,exit_37<br>	blt a4,t5,exit_37<br>	li t0,0 		#result<br>	li t1,0 		#i<br>	slli a3,a3,2		<br>	slli a4,a4,2<br>loop_start:<br>	beq t1,a2,loop_end<br>	lw t2,0(a0)<br>	lw t3,0(a1)<br><br>	mul t4,t2,t3<br>	add t0,t0,t4<br><br>	add a0,a0,a3<br>	add a1,a1,a4<br>	addi t1,t1,1<br>	j loop_start<br>exit_36:<br>	li a0 36<br>	j exit<br>exit_37:<br>	li a0 37<br>	j exit<br>loop_end:<br>	# Epilogue<br>	mv a0 t0<br>	ret<br></code></pre></td></tr></table></figure>

<h3 id="Task5-Matrix-Multiplication"><a href="#Task5-Matrix-Multiplication" class="headerlink" title="Task5: Matrix Multiplication"></a>Task5: Matrix Multiplication</h3><p>做了好久，刚开始写确实很乱，静下心梳理。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs assembly">matmul:<br>	ebreak<br>	# Error checks<br>	li t5, 1<br>	blt a1, t5, exit_38<br>	blt a2, t5, exit_38<br>	blt a4, t5, exit_38<br>	blt a5, t5, exit_38<br>	bne a2, a4, exit_38<br><br>	# Prologue<br>	addi sp, sp, -16<br>	sw s0, 0(sp)<br>	sw s1, 4(sp)<br>	sw s2, 8(sp)<br>	sw s3, 12(sp)<br>	li s0, 0     # i<br>	li s1, 0     # j<br><br>outer_loop_start:<br>	li s1, 0<br><br>inner_loop_start:<br>	# save context<br>	addi sp, sp, -32<br>	sw ra, 0(sp)<br>	sw a0, 4(sp)<br>	sw a1, 8(sp)<br>	sw a2, 12(sp)<br>	sw a3, 16(sp)<br>	sw a4, 20(sp)<br>	sw a5, 24(sp)<br>	sw a6, 28(sp)<br><br>	# set arguments for dot function<br>	addi t4, x0, 4<br>	mul t4, t4, s1<br>	add a1, a3, t4<br>	li a3, 1<br>	mv a4, a5<br><br>	# call dot function<br>	jal dot<br><br>	# get answer<br>	mv t1, a0<br><br>	# restore context<br>	lw ra, 0(sp)<br>	lw a0, 4(sp)<br>	lw a1, 8(sp)<br>	lw a2, 12(sp)<br>	lw a3, 16(sp)<br>	lw a4, 20(sp)<br>	lw a5, 24(sp)<br>	lw a6, 28(sp)<br>	addi sp, sp, 32<br><br>	# store result in the result matrix d<br>	mul t2, s0, a5<br>	add t2, t2, s1<br>	addi t4, x0, 4<br>	mul t2, t2, t4<br>	add t2, a6, t2<br>	sw t1, 0(t2)<br><br>inner_loop_end:<br>	addi s1, s1, 1<br>	beq s1, a5, outer_loop_end<br>	j inner_loop_start<br><br>outer_loop_end:<br>	addi s0, s0, 1<br>	addi t4, x0, 4<br>	mul t0, t4, a2<br>	add a0, a0, t0<br>	beq s0, a1, end<br>	j outer_loop_start<br><br><br>end:<br>	# Epilogue<br>	lw s0, 0(sp)<br>	lw s1, 4(sp)<br>	lw s2, 8(sp)<br>	lw s3, 12(sp)<br>	addi sp, sp, 16<br>	ret<br><br>exit_38:<br>	li a0, 38<br>	j exit<br></code></pre></td></tr></table></figure>

<p><strong>代码思路</strong></p>
<ol>
<li>首先，代码进行维度检查，确保输入矩阵的维度是有效的，如果任何一个维度小于1，则跳转到 <code>exit_38</code> 标签，终止程序。</li>
<li>然后，代码初始化一些寄存器和变量，为循环做准备。<code>s0</code> 用于追踪当前行，<code>s1</code> 用于追踪当前列。</li>
<li>进入外层循环 <code>outer_loop_start</code>，其中 <code>s0</code> 追踪矩阵 <code>m0</code> 的当前行。然后，进入内层循环 <code>inner_loop_start</code>，其中 <code>s1</code> 追踪矩阵 <code>m1</code> 的当前列。</li>
<li>在内层循环内，首先保存寄存器上下文，然设置<code>dot</code>函数的参数。<code>a0</code>不变，计算 <code>a1</code> 的地址（<code>a1</code> 是矩阵 <code>m1</code> 当前列的起始地址），<code>a2</code>不变，设置 <code>a3</code> 为 1，将 <code>a4</code> 设置为矩阵 <code>m1</code> 的列数。</li>
<li>调用 <code>dot</code> 函数，将矩阵 <code>m0</code> 的当前行和矩阵 <code>m1</code> 的当前列进行点积运算，结果保存在 <code>t1</code> 中。</li>
<li>恢复寄存器上下文，然后将 <code>t1</code> 的值存储在结果矩阵 <code>d</code> 中的对应位置。</li>
<li>内层循环结束后，增加 <code>s1</code> 的值，如果 <code>s1</code> 小于矩阵 <code>m1</code> 的列数，则继续内层循环。</li>
<li>外层循环结束后，增加 <code>s0</code> 的值，然后将 <code>a0</code> 更新为下一行的起始地址。如果 <code>s0</code> 小于矩阵 <code>m0</code> 的行数，则继续外层循环。</li>
<li>循环结束后，恢复寄存器上下文并返回。</li>
<li>如果发现维度无效，则跳转到 <code>exit_38</code>，程序终止。</li>
</ol>
<p><strong>计算a1地址</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs assembly">addi t4, x0, 4<br>mul t4, t4, s1<br>add a1, a3, t4<br></code></pre></td></tr></table></figure>

<p><strong>计算结果存储在结果矩阵d 的相对位置</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs assembly">mul t2, s0, a5<br>add t2, t2, s1<br>addi t4, x0, 4<br>mul t2, t2, t4<br>add t2, a6, t2<br>sw t1, 0(t2)<br></code></pre></td></tr></table></figure>

<ol>
<li><code>mul t2, s0, a5</code>: 这行代码计算了要存储的元素在结果矩阵 <code>d</code> 中的行号。<code>s0</code> 包含了当前正在计算的行号，而 <code>a5</code> 包含了矩阵 <code>m1</code> 的列数（也是结果矩阵 <code>d</code> 的列数）。将这两个值相乘，得到的结果存储在寄存器 <code>t2</code> 中。</li>
<li><code>add t2, t2, s1</code>: 这行代码将刚刚计算的行号 <code>t2</code> 与当前正在计算的列号 <code>s1</code> 相加。这是为了计算出在结果矩阵 <code>d</code> 中的具体位置。</li>
<li><code>addi t4, x0, 4</code>: 这行代码将立即数 4 存储在寄存器 <code>t4</code> 中。这是因为每个元素占用 4 个字节（假设是 32 位整数）。</li>
<li><code>mul t2, t2, t4</code>: 这行代码将刚刚计算的位置 <code>t2</code> 与每个元素的大小相乘，以得到字节偏移量。</li>
<li><code>add t2, a6, t2</code>: 这行代码将字节偏移量 <code>t2</code> 与结果矩阵 <code>d</code> 的起始地址相加，从而得到最终要存储的地址。</li>
<li><code>sw t1, 0(t2)</code>: 这行代码使用 <code>sw</code> 指令，将点积运算的结果 <code>t1</code> 存储在刚刚计算出的地址上，从而将计算结果存储在结果矩阵 <code>d</code> 中的对应位置。</li>
</ol>
<p><strong>更新矩阵a0 的行指针，以便在下一次循环中处理下一行</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs assembly">addi t4, x0, 4<br>mul t0, t4, a2<br>add a0, a0, t0<br></code></pre></td></tr></table></figure>

<ol>
<li><code>addi t4, x0, 4</code>: 这行代码将立即数 4 存储在寄存器 <code>t4</code> 中。这是因为每个元素占用 4 个字节（假设是 32 位整数）。</li>
<li><code>mul t0, t4, a2</code>: 这行代码将刚刚存储在寄存器 <code>t4</code> 中的值（即每个元素的大小）与矩阵 <code>m0</code> 的列数 <code>a2</code> 相乘，得到的结果存储在寄存器 <code>t0</code> 中。这是为了计算当前行中下一个元素的偏移量。</li>
<li><code>add a0, a0, t0</code>: 这行代码将刚刚计算出的偏移量 <code>t0</code> 加到矩阵 <code>m0</code> 的起始地址 <code>a0</code> 上，以更新行指针。这将使指针指向下一行的开头，以便在下一次循环中处理下一行</li>
</ol>
<h2 id="Part-B-File-Operations-and-Classification-09-14"><a href="#Part-B-File-Operations-and-Classification-09-14" class="headerlink" title="Part B: File Operations and Classification [09&#x2F;14]"></a>Part B: File Operations and Classification [09&#x2F;14]</h2><h3 id="Task-7-Read-Matrix"><a href="#Task-7-Read-Matrix" class="headerlink" title="Task 7: Read Matrix"></a>Task 7: Read Matrix</h3><p><strong>Matrices</strong> are stored in files as a consecutive sequence of 4-byte integers. The first and second integers in the file indicate the number of rows and columns in the matrix, respectively. The rest of the integers store the elements in the matrix in row-major order.</p>
<p>Fill in the <code>read_matrix</code> function in <code>src/read_matrix.s</code>. This function should do the following:</p>
<ol>
<li>以读取权限打开文件。 文件路径作为参数 (a0) 提供。</li>
<li>从文件中读取行数和列数（记住：它们是文件中的前两个整数）。 将这些整数存储在内存中提供的指针处（a1 表示行，a2 表示列）。</li>
<li>在堆上分配空间来存储矩阵。 （提示：使用上一步中的行数和列数来确定要分配多少空间。）</li>
<li>将矩阵从文件中读取到上一步分配的内存中。</li>
<li>关闭文件。</li>
<li>返回指向内存中矩阵的指针。</li>
</ol>
<p>参数要求：<a target="_blank" rel="noopener" href="https://inst.eecs.berkeley.edu/~cs61c/sp22/projects/proj2/part-b/#your-task">https://inst.eecs.berkeley.edu/~cs61c/sp22/projects/proj2/part-b/#your-task</a></p>
  <img src="/2023/08/12/cs61c-proj2/Task7_read_matrix_arguments.png" srcset="/img/loading.gif" lazyload class="" title="examplename">

<div class="note note-info">
            <p>c program</p>
          </div>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span>* <span class="hljs-title function_">read_matrix</span><span class="hljs-params">(<span class="hljs-type">char</span>* filename, <span class="hljs-type">int</span>* row, <span class="hljs-type">int</span>* col)</span>&#123;<br>	File* file = fopen(filename, <span class="hljs-string">&quot;rb&quot;</span>);<br>	<span class="hljs-keyword">if</span>(file == null)&#123;<br>		fopen_error();<br>	&#125;<br><br>	fread(row, size_4, <span class="hljs-number">1</span>, file);<br>	fread(col, size_4, <span class="hljs-number">1</span>, file);	<br><br>	<span class="hljs-type">int</span>* matrix = (<span class="hljs-type">int</span> *)<span class="hljs-built_in">malloc</span>((*row) * (*col) * size_4);<br>	<span class="hljs-keyword">if</span>(matrix == <span class="hljs-number">0</span>)&#123;<br>		matrix_error;<br>	&#125;<br>	<span class="hljs-type">int</span> byte_read = fread(matrix, size_4, (*row) * (*col), file);<br>	<span class="hljs-keyword">if</span>(byte_read != (*row) * (*col))&#123;<br>		<span class="hljs-built_in">free</span>(matrix);<br>		fclose(file);<br>		fread_error;<br>	&#125;<br>	<span class="hljs-keyword">if</span>(fclose(file) == <span class="hljs-number">-1</span>)&#123;<br>		fclose_error;<br>	&#125;<br>	<span class="hljs-keyword">return</span> matrix;<br>&#125;<br></code></pre></td></tr></table></figure>

<div class="note note-info">
            <p>risc-v code</p>
          </div>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs ass">read_matrix:<br><br>	# Prologue<br>	addi sp, sp, -32<br>	sw ra, 4(sp)<br>	sw s0, 8(sp)<br>	sw s1, 12(sp)<br>	sw s2, 16(sp)<br>	sw s3, 20(sp)<br>	sw s4, 24(sp)	<br>	sw s5, 28(sp)<br><br>	mv s1, a1<br>	mv s2, a2<br>	li a1, 0<br>	jal ra, fopen<br><br>	li t0, -1<br>	beq a0, t0, fopen_error<br>	sw a0, 0(sp)<br><br>	mv a1, s1<br>	li s3, 4<br>	mv a2, s3<br>	jal ra, fread<br>	bne a0, s3, fread_error<br><br>	lw a0, 0(sp)<br>	mv a1, s2<br>	li s3, 4<br>	mv a2, s3<br>	jal ra, fread<br>	bne, a0, s3, fread_error<br><br>	lw t0, 0(s1)<br>	lw t1, 0(s2)<br>	mul s4, t0, t1<br>	slli, s4, s4, 2<br>	mv a0, s4<br>	jal ra, malloc<br>	beqz a0, malloc_error<br><br>	mv s5, a0<br>	lw a0, 0(sp)<br>	mv a1, s5<br>	mv a2, s4<br>	jal ra, fread<br>	bne a0, s4, fread_error<br><br>	lw a0, 0(sp)<br>	jal ra, fclose<br>	bnez a0, fclose_error<br><br>	mv a0, s5<br><br>	# Epilogue<br>	lw ra, 4(sp)<br>	lw s0, 8(sp)<br>	lw s1, 12(sp)<br>	lw s2, 16(sp)<br>	lw s3, 20(sp)<br>	lw s4, 24(sp)	<br>	lw s5, 28(sp)<br>	addi sp, sp, 32<br>	ret<br><br><br>malloc_error:<br>	li a0, 26<br>	j exit<br>fopen_error:<br>	li a0, 27<br>	j exit<br>fclose_error:<br>	li a0, 28<br>	j exit<br>fread_error:<br>	li a0, 29<br>	j exit<br></code></pre></td></tr></table></figure>

<h3 id="Task-8-Write-Matrix"><a href="#Task-8-Write-Matrix" class="headerlink" title="Task 8: Write Matrix"></a>Task 8: Write Matrix</h3><p>Fill in the <code>write_matrix</code> function in <code>src/write_matrix.s</code>. This function should do the following:</p>
<ol>
<li>以写权限打开文件。 文件路径作为参数提供。</li>
<li>将行数和列数写入文件。 （提示：fwrite 函数需要一个指向内存中数据的指针，因此您应该首先将数据存储到内存，然后将指向数据的指针传递给 fwrite。）</li>
<li>将数据写入文件。</li>
<li>关闭文件。</li>
</ol>
<p>参数要求：<a target="_blank" rel="noopener" href="https://inst.eecs.berkeley.edu/~cs61c/sp22/projects/proj2/part-b/#task-8-write-matrix">https://inst.eecs.berkeley.edu/~cs61c/sp22/projects/proj2/part-b/#task-8-write-matrix</a></p>
<div class="note note-info">
            <p>c program</p>
          </div>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">write_matrix</span><span class="hljs-params">(<span class="hljs-type">char</span>* filename, <span class="hljs-type">int</span>*matrix, <span class="hljs-type">int</span> rows, <span class="hljs-type">int</span> cols)</span>&#123;<br>	File* file = fopen(filename,<span class="hljs-string">&quot;wb&quot;</span>);<br>	<span class="hljs-keyword">if</span>(file == null)&#123;<br>		fopen_error;<br>	&#125;<br>	fwrite(&amp;rows,size_4,<span class="hljs-number">1</span>,file);<br>	fwrite(&amp;cols,size_4,<span class="hljs-number">1</span>,file);<br><br>	fwrite(matrix,size_4,rows*cols,file);<br><br>	<span class="hljs-keyword">if</span>(fclose(file) == <span class="hljs-number">-1</span>)&#123;<br>		fclose_error;<br>	&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<div class="note note-info">
            <p>risc-v code</p>
          </div>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs assembly">write_matrix:<br><br>	# Prologue<br>	addi sp, sp, -32<br>	sw ra, 4(sp)<br>	sw s0, 8(sp)<br>	sw s1, 12(sp)<br>	sw s2, 16(sp)<br>	sw s3, 20(sp)<br>	sw s4, 24(sp)	<br>	sw s5, 28(sp)<br><br>	mv s0, a0<br>	mv s1, a1<br>	mv s2, a2<br>	mv s3, a3<br><br>	li a1, 1<br>	jal ra, fopen<br>	li t0, -1<br>	beq a0, t0, fopen_error<br>	mv s5, a0<br><br>	sw s2, 0(sp) # rows<br>	mv a0, s5<br>	mv a1, sp<br>	li s4, 1<br>	mv a2, s4<br>	li a3, 4<br>	jal ra, fwrite<br>	bne a0, s4, fwrite_error<br><br>	sw s3, 0(sp) # cols<br>	mv a0, s5<br>	mv a1, sp<br>	li s4, 1<br>	mv a2, s4<br>	li a3, 4<br>	jal ra, fwrite<br>	bne a0, s4, fwrite_error<br><br>	mul s4, s2, s3 # data<br>	mv a0, s5<br>	mv a1, s1<br>	mv a2, s4<br>	li a3, 4<br>	jal ra, fwrite<br>	bne a0, s4, fwrite_error<br><br>	mv a0, s5<br>	jal ra, fclose<br>	li t0, -1<br>	beq a0, t0, fclose_error<br><br>	# Epilogue<br>	lw ra, 4(sp)<br>	lw s0, 8(sp)<br>	lw s1, 12(sp)<br>	lw s2, 16(sp)<br>	lw s3, 20(sp)<br>	lw s4, 24(sp)	<br>	lw s5, 28(sp)<br>	addi sp, sp, 32<br>	ret<br><br>fopen_error:<br>	li a0, 27<br>	j exit<br>fwrite_error:<br>	li a0, 30<br>	j exit<br>fclose_error:<br>	li a0, 28<br>	j exit<br></code></pre></td></tr></table></figure>



<h3 id="Task-9-Classify"><a href="#Task-9-Classify" class="headerlink" title="Task 9: Classify"></a>Task 9: Classify</h3><p>最后一部分，写了两个晚上，将近8个小时左右</p>
<p>Fill in the <code>classify</code> function in <code>src/classify.s</code>. This function should do the following:</p>
<ol>
<li>从文件中读取三个矩阵 m0、m1 和输入。 它们的文件路径作为参数提供。 您需要为 read_matrix 的指针参数分配空间，因为该函数需要一个指向已分配内存的指针。</li>
<li>计算 h &#x3D; matmul(m0, 输入)。 您可能需要 malloc 空间以适合 h。</li>
<li>计算 h &#x3D; relu(h)。 请记住，relu 是就地执行的。</li>
<li>计算 o &#x3D; matmul(m1, h) 并将结果矩阵写入输出文件。 输出文件路径作为参数提供。</li>
<li>计算并返回argmax(o)。 如果 print 参数设置为 0，则还打印出 argmax(o) 和换行符。</li>
<li>释放使用 malloc 分配的所有数据。 这包括通过调用 read_matrix 分配的任何堆块。</li>
<li>请记住在返回之前将返回值 argmax(o) 放入适当的寄存器中。</li>
</ol>
<p>参数要求：<a target="_blank" rel="noopener" href="https://inst.eecs.berkeley.edu/~cs61c/sp22/projects/proj2/part-b/#task-9-classify">https://inst.eecs.berkeley.edu/~cs61c/sp22/projects/proj2/part-b/#task-9-classify</a></p>
<div class="note note-info">
            <p>c program，大体的一些，为了满足汇编函数的参数有些写得有些模糊</p>
          </div>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">classify</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv,<span class="hljs-type">int</span> a2)</span>&#123;<br>	<span class="hljs-type">int</span> num_rows_m0,num_cols_m0;<br>	<span class="hljs-type">int</span> num_rows_m1,num_cols_m1;<br>	<span class="hljs-type">int</span> num_rows_input,num_cols_input;<br>	<span class="hljs-type">int</span>* m0, m1, input;<br><br>	m0 = read_matrix(argv[<span class="hljs-number">1</span>],&amp;num_rows_m0,&amp;num_rows_m0);<br>	m1 = read_matrix(argv[<span class="hljs-number">2</span>],&amp;num_rows_m1,&amp;num_rows_m1);<br>	input = read_matrix(argv[<span class="hljs-number">3</span>],&amp;num_rows_input,&amp;num_rows_input);<br><br>	<span class="hljs-type">int</span>* h;<br>	matmul(m0,input,h)<br>	relu(h,h_size(num_rows_m0*num_cols_input));<br><br>	<span class="hljs-type">int</span>* o;<br>	matmul(m1,h,o);<br>	write_matrix(argv[<span class="hljs-number">4</span>],o,num_rows_m1,num_cols_input);<br><br>	<span class="hljs-type">int</span> classification = argmax(o,o_size);<br>	<span class="hljs-keyword">if</span>(a2 == <span class="hljs-number">0</span>)&#123;<br>		print_int(classification);<br>        print_char(<span class="hljs-string">&#x27;\n&#x27;</span>);<br>	&#125;<br>	<span class="hljs-built_in">free</span>(o);<br>	<span class="hljs-built_in">free</span>(h);<br>	<span class="hljs-built_in">free</span>(m0);<br>	<span class="hljs-built_in">free</span>(m1);<br>	<span class="hljs-built_in">free</span>(input);<br>	<span class="hljs-built_in">free</span>(num_rows_m0);<br>	...<br>	<span class="hljs-built_in">free</span>(num_cols_input);<br><br>	<span class="hljs-keyword">return</span> classification;<br>&#125;<br></code></pre></td></tr></table></figure>

<div class="note note-info">
            <p>risc-v code</p>
          </div>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><code class="hljs assembly">classify:<br>	# prologue<br>	addi sp, sp, -64<br>	sw s0, 12(sp)	# a1<br>	sw s1, 16(sp)	# a2<br>	sw s2, 20(sp)	# m0_pointer<br>	sw s3, 24(sp)	# m1_pointer<br>	sw s4, 28(sp)	# input_pointer<br>	sw s5, 32(sp)	<br>	sw s6, 36(sp)	# num_rows_input<br>	sw s7, 40(sp)	# num_cols_input<br>	sw s8, 44(sp)	# num_rows_m1<br>	sw s9, 48(sp)	# num_cols_m1<br>	sw s10, 52(sp)	# num_rows_m0<br>	sw s11, 56(sp)	# num_cols_m0<br>	sw ra, 60(sp)<br><br>	li t0, 5<br>	bne a0, t0, argnum_error<br>	mv s0, a1 # store argument pointer<br>	mv s1, a2 # store switcher<br><br>	# Read pretrained m0<br>	li a0, 4<br>	jal ra, malloc<br>	beqz a0, malloc_error<br>	mv s10, a0 <br>	li a0, 4<br>	jal ra, malloc<br>	beqz a0, malloc_error<br>	mv s11, a0 <br>	# read matrix<br>	lw a0, 4(s0)<br>	mv a1, s10<br>	mv a2, s11<br>	jal ra, read_matrix<br>	mv s2, a0<br><br>	# Read pretrained m1<br>	li a0, 4<br>	jal ra, malloc<br>	beqz a0, malloc_error<br>	mv s8, a0 <br>	li a0, 4<br>	jal ra, malloc<br>	beqz a0, malloc_error<br>	mv s9, a0 <br>	# read matrix<br>	lw a0, 8(s0)<br>	mv a1, s8<br>	mv a2, s9<br>	jal ra, read_matrix<br>	mv s3, a0<br><br>	# Read input matrix<br>	ebreak<br>	li a0, 4<br>	jal ra, malloc<br>	beqz a0, malloc_error<br>	mv s6, a0 <br>	li a0, 4<br>	jal ra, malloc<br>	beqz a0, malloc_error<br>	mv s7, a0 <br>	lw a0, 12(s0)<br>	mv a1, s6<br>	mv a2, s7<br>	jal ra, read_matrix<br>	mv s4, a0<br><br>	# Compute h = matmul(m0, input)<br>	lw t0, 0(s10)<br>	lw t1, 0(s7)<br>	# malloc<br>	mul t0, t0, t1<br>	sw t0, 8(sp)	# h_size<br>	slli a0, t0, 2 	# 4-byte per element<br>	jal ra, malloc<br>	beqz a0, malloc_error<br>	sw a0, 0(sp)	# h_pointer<br><br>	# matmul<br>	mv a0, s2<br>	lw a1, 0(s10)<br>	lw a2, 0(s11)<br>	mv a3, s4<br>	lw a4, 0(s6)<br>	lw a5, 0(s7)<br>	lw a6, 0(sp)<br>	jal ra, matmul<br><br>	# Compute h = relu(h)<br>	lw a0, 0(sp)<br>	lw a1, 8(sp)<br>	jal ra, relu<br><br>	# Compute o = matmul(m1, h)<br>	lw t0, 0(s8)<br>	lw t1, 0(s7)<br>	# malloc<br>	mul t0, t0, t1<br>	sw t0, 8(sp) 	# o_size<br>	slli a0, t0, 2 	# 4-byte per element<br>	jal ra, malloc<br>	sw a0, 4(sp)	# o_pointer<br><br>	# matmul<br>	mv a0, s3<br>	lw a1, 0(s8)<br>	lw a2, 0(s9)<br>	lw a3, 0(sp)<br>	lw a4, 0(s10)<br>	lw a5, 0(s7)<br>	lw a6, 4(sp)<br>	jal ra, matmul<br><br>	# Write output matrix o<br>	lw a0, 16(s0)<br>	lw a1, 4(sp)<br>	lw a2, 0(s8)<br>	lw a3, 0(s7)<br>	jal ra, write_matrix<br><br>	# Compute and return argmax(o)<br>	lw a0, 4(sp)<br>	lw a1, 8(sp)<br>	jal ra, argmax<br>	sw a0, 8(sp)	# argmax(o)<br><br>	# If enabled, print argmax(o) and newline<br>	bnez s1, done<br>	lw a0, 8(sp)<br>	jal ra, print_int<br>	li a0, &#x27;\n&#x27;<br>	jal ra, print_char<br>done:<br>	# free m0<br>	mv a0, s2<br>	jal ra, free<br>	# free m1<br>	mv a0, s3<br>	jal ra, free<br>	# free input<br>	mv a0, s4<br>	jal ra, free<br><br>	# free h<br>	lw a0, 0(sp)<br>	jal ra, free<br>	# free o<br>	lw a0, 4(sp)<br>	jal ra, free<br><br>	# free num&amp;col<br>	mv a0, s6<br>	jal ra, free<br>	mv a0, s7<br>	jal ra, free<br>	mv a0, s8<br>	jal ra, free<br>	mv a0, s9<br>	jal ra, free<br>	mv a0, s10<br>	jal ra, free<br>	mv a0, s11<br>	jal ra, free<br><br>	# return<br>	lw a0, 8(sp)<br><br><br>	# epilogue<br>	lw s0, 12(sp)	<br>	lw s1, 16(sp)	<br>	lw s2, 20(sp)	<br>	lw s3, 24(sp)	<br>	lw s4, 28(sp)	<br>	lw s5, 32(sp)	<br>	lw s6, 36(sp)	<br>	lw s7, 40(sp)	<br>	lw s8, 44(sp)	<br>	lw s9, 48(sp)	<br>	lw s10, 52(sp)	<br>	lw s11, 56(sp)<br>	lw ra, 60(sp)	<br>	addi sp, sp, 64<br><br>	ret<br>argnum_error:<br>	li a0, 31<br>	j exit<br>malloc_error:<br>	li a0, 26<br>	j exit<br></code></pre></td></tr></table></figure>


                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Architecture/" class="category-chain-item">Architecture</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/cs61c/" class="print-no-link">#cs61c</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>cs61c-proj2</div>
      <div>https://2333monster.github.io/2023/08/12/cs61c-proj2/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>John Titor</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年8月12日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/08/16/cs61c-lab03/" title="cs61c-lab03">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">cs61c-lab03</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/08/10/cs61c-lab02/" title="cs61c-lab02">
                        <span class="hidden-mobile">cs61c-lab02</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
    <div id="giscus" class="giscus"></div>
    <script type="text/javascript">
      Fluid.utils.loadComments('#giscus', function() {
        var options = {"repo":"2333monster/blog-comments","repo-id":"R_kgDOKAS-Hg","category":"Announcements","category-id":"DIC_kwDOKAS-Hs4CYKXb","theme-light":"light","theme-dark":"dark","mapping":"pathname","reactions-enabled":1,"emit-metadata":0,"input-position":"top","lang":"zh-CN"};
        var attributes = {};
        for (let option in options) {
          if (!option.startsWith('theme-')) {
            var key = option.startsWith('data-') ? option : 'data-' + option;
            attributes[key] = options[option];
          }
        }
        var light = 'light';
        var dark = 'dark';
        window.GiscusThemeLight = light;
        window.GiscusThemeDark = dark;
        attributes['data-theme'] = document.documentElement.getAttribute('data-user-color-scheme') === 'dark' ? dark : light;
        for (let attribute in attributes) {
          var value = attributes[attribute];
          if (value === undefined || value === null || value === '') {
            delete attributes[attribute];
          }
        }
        var s = document.createElement('script');
        s.setAttribute('src', 'https://giscus.app/client.js');
        s.setAttribute('crossorigin', 'anonymous');
        for (let attribute in attributes) {
          s.setAttribute(attribute, attributes[attribute]);
        }
        var ss = document.getElementsByTagName('script');
        var e = ss.length > 0 ? ss[ss.length - 1] : document.head || document.documentElement;
        e.parentNode.insertBefore(s, e.nextSibling);
      });
    </script>
    <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
